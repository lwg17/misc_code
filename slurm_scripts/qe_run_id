#!/bin/bash

# Usage: ./run_qe_slurm.sh inputfile.pwi

# Capture current working directory
work_dir=$(pwd)
user_name=$(whoami)

# Check for input file
if [ $# -ne 1 ]; then
  echo "Usage: $0 inputfile.pwi"
  exit 1
fi

# Extract filename and base name
input_path="$1"
input_file=$(basename "$input_path")
basename="${input_file%.pwi}"

/usr/bin/sbatch << EOF
#!/bin/bash
#SBATCH --partition=main
#SBATCH --job-name=QEspresso
#SBATCH --nodes=1
#SBATCH --ntasks=28
#SBATCH --mem=120000
#SBATCH --time=72:00:00
#SBATCH --output=slurm.%N.%j.out
#SBATCH --error=slurm.%N.%j.out
#SBATCH --export=ALL
#SBATCH --mail-user=lwg17@scarletmail.rutgers.edu
#SBATCH --mail-type=END
#SBATCH --requeue

# ---- Queue/wait-time logging (single CSV in your home) ----
export SLURM_QUEUE_LOG="$HOME/slurm_wait_times.csv"
export LOG_ON_EXIT=1
source "$HOME/bin/slurm_queue_logger.sh" 2>/dev/null || echo "[warn] logger not found at $HOME/bin/slurm_queue_logger.sh"

# Load QE environment
module purge
module use /projects/community/modulefiles
module load intel/19.0.3
module load QE/6.4.1_intel19.0.3-kholodvl

# Change to job submit directory
cd \$SLURM_SUBMIT_DIR

# Set dynamic output file name
output_file="${basename}_\${SLURM_JOB_ID}.pwo"

# Echo diagnostic info
echo "Running on host: \$(hostname)"
echo "Start time: \$(date)"
echo "Running QE on file: $input_file"
echo "Output will be written to: \${output_file}"

# Execute QE
pw.x -in "$input_file" > "\$output_file"

echo "Finished at: \$(date)"
EOF
